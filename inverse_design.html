---

title: Inverse Design


keywords: fastai
sidebar: home_sidebar

summary: "A smarter way to do inverse design, using the conditional generator."
description: "A smarter way to do inverse design, using the conditional generator."
nb_path: "notebooks/07_inverse_design.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: notebooks/07_inverse_design.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>This notebook was adapted from Ceviche's <a href="https://github.com/fancompute/workshop-invdesign/blob/master/02_Invdes_intro.ipynb">inverse design introduction</a> to use a JAX-based optimization loop in stead of the default Ceviche optimization loop.</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>Our toy optimization problem will be to design a device that converts an input in the first-order mode into an output as the second-order mode. First, we define the parameters of our device and optimization:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Angular frequency of the source in Hz</span>
<span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">200e12</span>
<span class="c1"># Spatial resolution in meters</span>
<span class="n">dl</span> <span class="o">=</span> <span class="mf">40e-9</span>
<span class="c1"># Number of pixels in x-direction</span>
<span class="n">Nx</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># Number of pixels in y-direction</span>
<span class="n">Ny</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># Number of pixels in the PMLs in each direction</span>
<span class="n">Npml</span> <span class="o">=</span> <span class="mi">20</span>
<span class="c1"># Initial value of the structure&#39;s relative permittivity</span>
<span class="n">epsr_init</span> <span class="o">=</span> <span class="mf">12.0</span>
<span class="c1"># Space between the PMLs and the design region (in pixels)</span>
<span class="n">space</span> <span class="o">=</span> <span class="mi">10</span>
<span class="c1"># Width of the waveguide (in pixels)</span>
<span class="n">wg_width</span> <span class="o">=</span> <span class="mi">12</span>
<span class="c1"># Length in pixels of the source/probe slices on each side of the center point</span>
<span class="n">space_slice</span> <span class="o">=</span> <span class="mi">8</span>
<span class="c1"># Number of epochs in the optimization</span>
<span class="n">Nsteps</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># Step size for the Adam optimizer</span>
<span class="n">step_size</span> <span class="o">=</span> <span class="mf">1e-2</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Brush">Brush<a class="anchor-link" href="#Brush"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">brush</span> <span class="o">=</span> <span class="n">notched_square_brush</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">show_mask</span><span class="p">(</span><span class="n">brush</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Initial-Device">Initial Device<a class="anchor-link" href="#Initial-Device"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Initialize the parametrization rho and the design region</span>
<span class="n">epsr</span><span class="p">,</span> <span class="n">bg_epsr</span><span class="p">,</span> <span class="n">design_region</span><span class="p">,</span> <span class="n">input_slice</span><span class="p">,</span> <span class="n">output_slice</span> <span class="o">=</span> <span class="n">init_domain</span><span class="p">(</span>
    <span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">,</span> <span class="n">Npml</span><span class="p">,</span> <span class="n">space</span><span class="o">=</span><span class="n">space</span><span class="p">,</span> <span class="n">wg_width</span><span class="o">=</span><span class="n">wg_width</span><span class="p">,</span> <span class="n">space_slice</span><span class="o">=</span><span class="n">space_slice</span>
<span class="p">)</span>

<span class="n">epsr_total</span> <span class="o">=</span> <span class="n">mask_combine_epsr</span><span class="p">(</span><span class="n">epsr</span><span class="p">,</span> <span class="n">bg_epsr</span><span class="p">,</span> <span class="n">design_region</span><span class="p">)</span>

<span class="c1"># Setup source</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">insert_mode</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="n">dl</span><span class="p">,</span> <span class="n">input_slice</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">input_slice</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">epsr_total</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Setup probe</span>
<span class="n">probe</span> <span class="o">=</span> <span class="n">insert_mode</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="n">dl</span><span class="p">,</span> <span class="n">output_slice</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">output_slice</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">epsr_total</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">simulation</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">viz_sim</span><span class="p">(</span><span class="n">epsr_total</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">slices</span><span class="o">=</span><span class="p">[</span><span class="n">input_slice</span><span class="p">,</span> <span class="n">output_slice</span><span class="p">])</span>

<span class="c1"># get normalization factor (field overlap before optimizing)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Ez</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="n">E0</span> <span class="o">=</span> <span class="n">mode_overlap</span><span class="p">(</span><span class="n">Ez</span><span class="p">,</span> <span class="n">probe</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_design_region</span><span class="p">(</span><span class="n">epsr</span><span class="p">,</span> <span class="n">design_region</span><span class="o">=</span><span class="n">design_region</span><span class="p">):</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">design_region</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">design_region</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">epsr</span><span class="p">[</span><span class="n">I</span><span class="p">,:][:,</span><span class="n">J</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">set_design_region</span><span class="p">(</span><span class="n">epsr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">design_region</span><span class="o">=</span><span class="n">design_region</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">design_region</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">epsr</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Latent-Weights">Latent Weights<a class="anchor-link" href="#Latent-Weights"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">latent</span> <span class="o">=</span> <span class="n">new_latent_design</span><span class="p">((</span><span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">),</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">latent_t</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">latent</span><span class="p">,</span> <span class="n">brush</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">get_design_region</span><span class="p">(</span><span class="n">latent_t</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Forward-Pass">Forward Pass<a class="anchor-link" href="#Forward-Pass"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">design</span> <span class="o">=</span> <span class="n">generate_feasible_design</span><span class="p">(</span><span class="n">latent_t</span><span class="p">,</span> <span class="n">brush</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mask</span> <span class="o">=</span> <span class="n">generate_feasible_design_mask</span><span class="p">(</span><span class="n">latent_t</span><span class="p">,</span> <span class="n">brush</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">time</span> mask = generate_feasible_design_mask(latent_t, brush, )
<span class="n">full_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">epsr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="c1">#full_mask = set_design_region(full_mask, mask)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">full_mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sadfasdfasdf</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="forward" class="doc_header"><code>forward</code><a href="https://github.com/flaport/inverse_design/tree/master/inverse_design/inverse_design.py#L70" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>forward</code>(<strong><code>latent_weights</code></strong>, <strong><code>brush</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">latent_weights</span><span class="p">,</span> <span class="n">brush</span><span class="p">):</span>
    <span class="n">latent_t</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">latent_weights</span><span class="p">,</span> <span class="n">brush</span><span class="p">)</span>
    <span class="n">design_mask</span> <span class="o">=</span> <span class="n">generate_feasible_design_mask</span><span class="p">(</span><span class="n">latent_t</span><span class="p">,</span> <span class="n">brush</span><span class="p">)</span>
    <span class="n">epsr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">design_mask</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="loss_fn" class="doc_header"><code>loss_fn</code><a href="https://github.com/flaport/inverse_design/tree/master/inverse_design/inverse_design.py#L76" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>loss_fn</code>(<strong><code>epsr</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">loss_fn</span><span class="p">(</span><span class="n">epsr</span><span class="p">):</span>
    <span class="n">epsr</span> <span class="o">=</span> <span class="n">epsr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">))</span>
    <span class="n">simulation</span><span class="o">.</span><span class="n">eps_r</span> <span class="o">=</span> <span class="n">mask_combine_epsr</span><span class="p">(</span><span class="n">epsr</span><span class="p">,</span> <span class="n">bg_epsr</span><span class="p">,</span> <span class="n">design_region</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Ez</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">mode_overlap</span><span class="p">(</span><span class="n">Ez</span><span class="p">,</span> <span class="n">probe</span><span class="p">)</span> <span class="o">/</span> <span class="n">E0</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">grad_fn</span> <span class="o">=</span> <span class="n">jacobian</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reverse&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Optimization">Optimization<a class="anchor-link" href="#Optimization"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">simulation</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">viz_sim</span><span class="p">(</span><span class="n">epsr_total</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">slices</span><span class="o">=</span><span class="p">[</span><span class="n">input_slice</span><span class="p">,</span> <span class="n">output_slice</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">init_fn</span><span class="p">,</span> <span class="n">update_fn</span><span class="p">,</span> <span class="n">params_fn</span> <span class="o">=</span> <span class="n">adam</span><span class="p">(</span><span class="n">step_size</span><span class="p">)</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">init_fn</span><span class="p">(</span><span class="n">epsr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>this is the optimization step:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="step_fn" class="doc_header"><code>step_fn</code><a href="https://github.com/flaport/inverse_design/tree/master/inverse_design/inverse_design.py#L86" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>step_fn</code>(<strong><code>step</code></strong>, <strong><code>state</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>we can now loop over the optimization:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">range_</span> <span class="o">=</span> <span class="n">trange</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">range_</span><span class="p">:</span>
    <span class="n">loss</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">step_fn</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="n">range_</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">loss</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">epsr_optimum</span> <span class="o">=</span> <span class="n">params_fn</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="n">epsr_optimum</span> <span class="o">=</span> <span class="n">epsr_optimum</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">Nx</span><span class="p">,</span> <span class="n">Ny</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">epsr_optimum_total</span> <span class="o">=</span> <span class="n">mask_combine_epsr</span><span class="p">(</span><span class="n">epsr_optimum</span><span class="p">,</span> <span class="n">bg_epsr</span><span class="p">,</span> <span class="n">design_region</span><span class="p">)</span>
<span class="n">simulation</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">viz_sim</span><span class="p">(</span><span class="n">epsr_optimum_total</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">slices</span><span class="o">=</span><span class="p">[</span><span class="n">input_slice</span><span class="p">,</span> <span class="n">output_slice</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>At the end of the optimization we can see our final device. From the field pattern, we can easily observe that the device is doing what we intend: the <em>even</em> mode enters from the left and exits as the <em>odd</em> mode on the right.</p>
<p>However, an additional observation is that our device's permittivity changes continuously. This is not ideal if we wanted to fabricated our device. We're also not constraining the minimum and maximum values of $\epsilon_r$. Thus, we need to consider alternative ways of parameterizing our device.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">epsr_optimum_total</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">*</span><span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;n&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

